# Labweek11 系统概要设计说明书

姓名|学号|版本管理员
--|:--:|--:
何青阳|19335055|√
贺雅迪|19335058|
曾嘉乐|19335009|
## 1. 引言
### 1.1 编写目的
1.为开发成员和服务器用户之间提供共同的协议创立基础，对web服务器开发作功能描述
2.对本阶段对系统做的所有概要设计进行详细的说明，为软件开发者进行详细设计和编程提供基础

### 1.2 项目背景

因特网（Internet）是一个全球性的计算机互联网络，因特网上具有大量的技术资料数据库，其信息媒体包括数据、图像、文字、声音、视频等多种形式，信息属性有数据、交换软件、图书、档案等等。信息内容涉及通信、天文、医疗、政府机关、娱乐等各个方面。
万维网（WWW，也可简称为web）是因特网的一部分，它是一种建立在因特网上的全球性的
交互的、动态的分布式的信息系统，是一种建立在因特网上的网络服务。它的最基本概念就是超文本传输。
网络技术是当前计算机领域的的热门方向之一，在日常生活中，网络为我们的学习、工作、娱乐提供了极大的便利条件，在信息时代，网络编程对程序员来说是一项非常重要的技能。
### 1.3 定义
开发人员：开发本文档所介绍产品的程序员
MySQL：系统服务器使用的数据库管理系统
RAII机制：资源获取即初始化，在构造函数中申请分配资源，在析构函数中释放资源
Webbench:一种压力测试工具
### 1.4 参考资料
GB/T 8567-1988

## 2. 总体设计
### 2.1 需求规定
#### 2.1.1 系统功能
本项目产品表现为运行在linux系统上的服务器，客户可以使用网页浏览器通过公网访问服务器提供的资源，如网页、文件、计算等。此外，服务器提供客户身份认证、文件存储和安全传输等功能。
用户可以在网站注册账户并登录，登陆后可以按照权限访问服务器提供的资源，浏览网页并与网页交互，上传和下载。
#### 2.1.2 系统性能
本项目需要的相关网络技术已经较为成熟，相关理论知识的文献较为完备，所需软件配置齐全。最终完成的服务器将通过压力测试以确保较高的可靠性与灵活性，并能支持上万并发连接数的数据交换。
### 2.2 运行环境
操作系统：Linux
软件平台：Visual Studio Code
系统开发语言：c++、Java
数据库系统：MySQL
接口包括数据通信协议：TCP/IP协议
HTTP协议

### 2.3 基本设计概念和处理流程
- 设计概念
1. 采用线程池＋非阻塞socket+epoll+事件处理的并发模型
2. 使用状态机解析HTTP请求报文，支持解析GET和POST请求
3. 完成访问数据库实现的注册和登录功能及校验
4. 实现记录服务器运行状态的同步/异步日志系统
5. 实现上万并发连接数的数据交换（用Webbench进行压力测试)
- 主要处理流程

![序列](https://gitee.com/legolasmua/hwrlmoel/raw/master/week09/uml/%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

![活动](https://gitee.com/legolasmua/hwrlmoel/raw/master/week09/%E8%A1%8C%E4%B8%BA.png)

### 2.4 结构
服务器主要由I/O单元，逻辑单元和网络存储单元组成，其中每个单元之间通过请求队列进行通信，从而协同完成任务。其中I/O单元用于处理客户端连接，读写网络数据；逻辑单元用于处理业务逻辑的线程；网络存储单元指本地数据库和文件等。
1. 线程同步机制包装
通过锁机制实现多线程同步，确保任一时刻只能有一个线程能进入关键代码段。类中主要是Linux下三种锁进行封装，将锁的创建于销毁函数封装在类的构造与析构函数中，实现RAII机制
2. http连接请求处理
- 浏览器端发出http连接请求，主线程创建http对象接收请求并将所有数据读入对应buffer，将该对象插入任务队列，工作线程从任务队列中取出一个任务进行处理。
- 工作线程取出任务后，调用process_read函数，通过主、从状态机对请求报文进行解析。
- 解析完之后，跳转do_request函数生成响应报文，通过process_write写入buffer，返回给浏览器端。
3. 半同步/半反应堆线程池
半同步/半反应堆并发模式是半同步/半异步的变体，将半异步具体化为某种事件处理模式。
- 主线程充当异步线程，负责监听所有socket上的事务
- 若有新请求到来，主线程接收之以得到新的连接socket，然后往epoll内核事件表中注册该socket上的读写事
- 如果连接socket上有读写事件发生，主线程从socket上接收数据，并将数据封装成请求对象插入到请求队列
- 所有工作线程睡眠在请求队列上，当有任务到来时，通过竞争（如互斥锁）获得任务的接管权
构造函数中创建线程池,pthread_create函数中将类的对象作为参数传递给静态函数(worker),在静态函数中引用这个对象,并调用其动态方法(run)。
具体的，类对象传递时用this指针，传递给静态函数后，将其转换为线程池类，并调用私有成员函数run实现工作线程从请求队列中取出某个任务进行处理。
通过list容器创建请求队列，向队列中添加时，通过互斥锁保证线程安全，添加完成后通过信号量提醒有任务要处理。
4. 定时器处理非活动连接
定时器处理非活动连接模块，主要分为两部分：定时方法与信号通知流程;定时器及其容器设计与定时任务的处理
项目中将连接资源、定时事件和超时时间封装为定时器类，具体的，连接资源包括客户端套接字地址、文件描述符和定时器。定时事件为回调函数，将其封装起来由用户自定义。定时器超时时间 = 浏览器和服务器连接时刻 + 固定时间(TIMESLOT)，定时器使用绝对时间作为超时值，这里alarm设置为5秒，连接超时为15秒。
项目中的定时器容器为带头尾结点的升序双向链表，具体的为每个连接创建一个定时器，将其添加到链表中，并按照超时时间升序排列。执行定时任务时，将到期的定时器从链表中删除。从实现上看，主要涉及双向链表的插入，删除操作，其中添加定时器的事件复杂度是O(n),删除定时器的事件复杂度是O(1)。
5. 同步/异步日志系统
使用单例模式创建日志系统，对服务器运行状态、错误信息和访问数据进行记录。保证一个类仅有一个实例，并提供一个访问它的全局访问点，该实例被所有程序模块共享。采用阻塞队列
将生产者-消费者模型进行封装，使用循环数组实现队列，作为两者共享的缓冲区。
6. 数据库连接池
使用单例模式和链表创建数据库连接池，实现对数据库连接资源的复用。
- 初始化
销毁连接池没有直接被外部调用，而是通过RAII机制来完成自动释放；使用信号量实现多线程争夺连接的同步机制，将信号量初始化为数据库的连接总数。
- 获取、释放连接
当线程数量大于数据库连接数量时，使用信号量进行同步，每次取出连接，信号量原子减1，释放连接原子加1，若连接池内没有连接了，则阻塞等待。另外，由于多线程操作连接池，会造成竞争，这里使用互斥锁完成同步，具体的同步机制均使用lock.h中封装好的类。
- 销毁连接池
通过迭代器遍历连接池链表，关闭对应数据库连接，清空链表并重置空闲连接和现有连接数量。
7. 同步线程注册和登录校验
使用数据库连接池实现服务器访问数据库的功能，使用POST请求完成注册和登录的校验工作。
服务器端解析浏览器的请求报文，当解析为POST请求时，cgi标志位设置为1，并将请求报文的消息体赋值给m_string，进而提取出用户名和密码。
通过m_url定位/所在位置，根据/后的第一个字符判断是登录还是注册校验。2为登录校验，3为注册校验，对数据库进行操作时，需要通过锁来同步。
通过m_url定位/所在位置，根据/后的第一个字符，使用分支语句实现页面跳转。0为跳转注册页面，GET；1为跳转登录页面，GET；5为显示图片页面，POST；6为显示视频页面，POST；7为显示关注页面，POST



### 2.5 功能需求与程序的关系
功能需求|程序
--|:--:
记录服务器运行状态|同步/异步日志系统
I/O处理和逻辑处理|半同步/半反应堆线程池
用户进入服务器|登录与注册系统
sql数据库连接|数据库连接池
客户端与服务器对接|http连接请求处理

### 2.6 人工处理过程
服务器管理员可以增加、删除、修改、上传资源
### 2.7 尚未解决的问题
暂无

## 3. 接口设计
### 3.1 用户接口
用户登录界面：当用户访问正确的网址时，进入用户登录界面。该界面至少包含用户名输入栏和密码输入栏以便接受用户的输入，还应该有“登录”按钮使得用户可以提交用户名和密码和“注册”按钮。

注册界面：用户点击用户登录界面的“注册”按钮后可以进入注册界面。该界面应提供“用户名”、“昵称”、“密码”、“确认密码”栏供用户输入，还应该提供“提交”按钮让用户提交用户信息并完成注册。

主界面：用户提供正确的用户名和密码后，跳转到该界面。该界面显示当前用户权限级别下可以获取的全部资源。用户可以点击特定资源条目查看详情。

资源详情界面：用户查看资源详情并获取下载链接。

上传界面：用户可以向服务器上传文件，并设置其他用户对该文件的访问权限。

管理员界面：管理员可以对资源进行封锁、解封操作，对用户进行注销操作。

### 3.2 内部接口
线程池与http连接池：http连接池中包含了数据库连接池的信息，在http连接池初始化时，应向其提供数据库连接池的信息。
http连接与TCP连接：为每一个TCP连接请求维护一个http连接，在生成http连接时，需提供其依附的TCP连接对应的socket信息。
http与sql连接：http连接需要sql中的用户数据来验证用户身份，在http连接初始化时，应向其提供本地数据库信息。
http连接与计时器：计时器维护当前所有连接处于非活跃状态的时长，时长达到一定值时，释放当前连接占用的资源并抛弃此连接。
### 3.3 外部接口
*3.3.1 软件接口*
MySQL8.0
浏览器
*3.3.2 硬件接口*
暂无

## 4. 运行设计
### 4.1 运行模块组合
管理员查看用户信息、编辑用户信息、修改资源状态功能模块组合。
用户上传、下载资源、编辑资源信息模块组合。
系统显示资源详情、提供资源预览与下载链接功能模块组合。
系统输出日志模块。
### 4.2 运行控制
用户需要登录用户名、验证密码，系统核对后才能进行相关操作。
管理员需要登录用户名、验证密码，系统核对后才能进行相关操作。

### 4.3 运行时间
*4.3.1 耗时少的功能模块*
用户登录，资源查看、资源信息编辑。
*4.3.2 耗时多的功能模块*
资源上传与下载。

## 5. 系统数据结构设计

### 5.1 逻辑结构设计要点

线程池：采用半同步半反应堆模式，线程池是一个pthread_t类型的数组。

![2](https://gitee.com/legolasmua/hwrlmoel/raw/master/week11_fig/2.png)

数据库连接池：采用类似于线程池的做法，预先生成一些数据库连接以供用户请求使用。

每一个数据库连接的流程：

![3](https://gitee.com/legolasmua/hwrlmoel/raw/master/week11_fig/3.png)

这样的连接通过链表来存储。连接池的获取和释放被所有线程共享，应用锁机制。

用户注册信息（用户名和密码）用 map<string, string> 在服务器中存储从数据库中user表得到的用户名和密码。

![4](https://gitee.com/legolasmua/hwrlmoel/raw/master/week11_fig/4.png)

### 5.2 数据结构设计与程序的关系 

|initmysql_result|threadpool|lock
--|:--:|:--:|--:
线程池||√|√
数据库连接池|√|√|√
用户注册信息|√|




## 6. 系统出错处理设计

### 6.1 出错信息

输出形式|输出值|含义|处理方法
--|:--:|:--:|--:
int|001|请求过多服务器忙|中断部分线程，抛出异常信息
int|002|数据库连接失败|重新连接数据库，抛出异常信息
int|003|其他服务器错误|中断程序，抛出异常信息

### 6.2 补救措施

首先捕捉并输出错误代号，将错误信息输出在页面上，按照出错信息进行补救，并记入日志。

